
! #########################################################################
! Chapter 7 Lab-1 Configure Routing Facilities to the Branch Office
!
! File: RTR.Lab.7-1.Routing.Facilities.to.Branch.Office
!
! Procedures:
!  1. Prepare the routers and configure the router hostname and interface 
!     addresses
!    a. Cable the network as shown in the topology diagram
!    b. Verifying interface configuration 
!    c. Verifying connectivity from Branches (tcl)
!    d. Configuring static route for HQ and Branches to ISP
!    e. Verifying connectivity as step 1.c 
!    f. Verifying connectivity as step 1.c but from Branch LAN interface
!  2. Configuring NAT on the Branch and HQ routers
!    a. Configuring NAT for Branch router
!    b. Configuring NAT for HQ router
!    c. Verifying NAT configuration
!    d. Verifying NAT connectivity from Branch LAN
!    e. Verifying NAT configuration after ping traffic
!    f. Clearing NAT translations and Verifying connectivity btw Branch & HQ
!  3. Implement an IPsec VPN between the Branch and HQ sites
!    a. Configuring IPsec VPN
!    b. Verifying IPsec VPN
!    c. Verifying connectivity btw Branch & HQ
!    d. Verifying VPN tunnel details
!    e. Disabling IPsec VPN
!  4. Implement GRE over IPsec
!    a. Configuring GRE tunnel btw HQ and Branch 
!    b. Verifying tunnel interface
!    c. Verifying connectivity over GRE tunnel
!    d. Verifying traffic encryption
!    e. Configuring crypto ACL 
!    f. Verifying connectivity
!    g. Verifying IPsec session
!    h. Verifying connectivity btw LANs
!    i. Verifying routing table
!    j. Configuring EIGRP
!    k. Verifying routing table
!    l. Verifying IPsec session
!    m. Verifying end-to-end connectivity and IPsec session
!    n. Tracing path from Branch LAN to enmail server
!    o. Proving Internet access w/o GRE tunnel
!
!
! 1. Prepare the routers and configure the router hostname and interface 
!    addresses
! a. Cable the network as shown in the topology diagram
!
! Branch
hostname Branch
! 
interface Loopback1
 description Branch LAN
 ip address 192.168.1.1 255.255.255.0
!
interface Serial0/0
 description Connection to ISP
 ip address 209.165.200.242 255.255.255.248
 bandwidth 64
 no shut

! HQ
hostname HQ
!
interface Loopback1
 description Headquarters LAN
 ip address 10.10.10.1 255.255.255.0
!
interface Serial0/0
 description Connection to ISP
 ip address 209.165.200.226 255.255.255.248
 clock rate 64000
 bandwidth 64
 no shut

! ISP
hostname ISP
!
interface Loopback1
 description Simulating the Internet
 ip address 209.165.202.129 255.255.255.240
!
interface Serial0/0
 description Connection to Branch
 ip address 209.165.200.241 255.255.255.248
 clock rate 64000
 bandwidth 64
 no shut
!
interface Serial0/1
 description Connection to HQ
 ip address 209.165.200.225 255.255.255.248
 bandwidth 64
 no shut
 ex

ip route 209.165.200.232 255.255.255.248 Serial0/1
ip route 209.165.200.248 255.255.255.248 Serial0/0

! b. Verifying interface configuration 
!
! Branch
do sh ip int bri

! c. Verifying connectivity from Branches (tcl)
!
! Branch
end

tclsh

foreach addr {
 209.165.200.241
 209.165.202.129
 209.165.200.226
} {ping $addr}

exit

! d. Configuring static route for HQ and Branches to ISP
!
! Branch
conf t

ip route 0.0.0.0 0.0.0.0 209.165.200.241

! HQ
ip route 0.0.0.0 0.0.0.0 209.165.200.225

! e. Verifying connectivity as step 1.c 
!
! Branch
end

tclsh

foreach addr {
 209.165.200.241
 209.165.202.129
 209.165.200.226
} {ping $addr}

exit

! f. Verifying connectivity as step 1.c but from Branch LAN interface
!
! Branch
tclsh

foreach addr {
 209.165.200.241
 209.165.202.129
 209.165.200.226
} {ping $addr so 192.168.1.1}

exit

! 2. Configuring NAT on the Branch and HQ routers
! a. Configuring NAT for Branch router
!
! Branch
ip access-list extended BRANCH-NAT-ACL
 remark Do not translate Local LAN to HQ LAN addresses
 200 deny ip 192.168.1.0 0.0.0.255 10.10.0.0 0.0.255.255
 remark Translate Local LAN to all other Internet destinations
 210 permit ip 192.168.1.0 0.0.0.255 any
 exit
!
ip nat pool BRANCH-NAT-POOL 209.165.200.249 209.165.200.254 prefix-length 29
!
ip nat inside source list BRANCH-NAT-ACL pool BRANCH-NAT-POOL
!
interface Loopback 1
 ip nat inside
!
interface Serial0/0
 ip nat outside

! b. Configuring NAT for HQ router
!
! HQ
interface Loopback 0
 description HQ email server address
 ip add 10.10.20.238 255.255.255.0
!
ip nat pool HQ-NAT-POOL 209.165.200.233 209.165.200.237 prefix-length 29
ip nat inside source list HQ-NAT-ACL pool HQ-NAT-POOL
ip nat inside source static 10.10.20.238 209.165.200.238
!
ip access-list extended HQ-NAT-ACL
 remark Do not translate HQ LAN to Branch LAN addresses
 200 deny ip 10.10.0.0 0.0.255.255 192.168.1.0 0.0.0.255
 remark Translate Local LAN to all other Internet destinations
 210 permit ip 10.10.0.0 0.0.255.255 any
exit
!
interface Loopback 0
 ip nat inside
!
interface Loopback 1
 ip nat inside
!
interface Serial0/0
 ip nat outside

! c. Verifying NAT configuration
!
! Branch
do sh ip nat stat

! d. Verifying NAT connectivity from Branch LAN
!
! Branch
end 

tclsh

foreach addr {
 209.165.200.241
 209.165.202.129
 209.165.200.226
 209.165.200.238
} {ping $addr so 192.168.1.1}

exit

do pi 209.165.200.241 so 192.168.1.1
do pi 209.165.202.129 so 192.168.1.1
do pi 209.165.200.226 so 192.168.1.1
do pi 209.165.200.238 so 192.168.1.1


! e. Verifying NAT configuration after ping traffic
!
! Branch
conf t

do sh ip nat stat

do sh ip nat tran

! f. Clearing NAT translations and Verifying connectivity btw Branch & HQ
!
! Branch
do clear ip nat tran *

do pi 10.10.10.1 so 192.168.1.1

do sh ip nat tran

! 3. Implement an IPsec VPN between the Branch and HQ sites
!
! IPsec basic configurations
! 1. The ISAKMP policy identifies the specifics for the initial key and 
!     secure parameters exchange.
! 2. The IPsec details define how the IP packet is encapsulated.
! 3. The VPN tunnel information is identified in a named crypto map which 
!     combines the ISAKMP policies, IPsec packet detail, the peer address, 
!     and the crypto ACL.
! 4. The crypto ACL identifies traffic that will trigger the tunnel to 
!     activate. This component must sometimes be tuned when implemented 
!     along with other services such as NAT and GRE.
! 5. The crypto map is then applied to the tunnel interface.
!
! a. IPsec configuration
!
! Branch
crypto isakmp policy 1
 encryption aes
 authentication pre-share
 group 2
!
crypto isakmp key cisco123 address 209.165.200.226
!
crypto ipsec transform-set HQ-VPN esp-3des esp-sha-hmac
!
crypto map HQ-MAP 10 ipsec-isakmp
 set peer 209.165.200.226
 set transform-set HQ-VPN
 match address HQ-VPN-ACL
!
ip access-list extended HQ-VPN-ACL
 remark Branch to HQ traffic to trigger VPN
 10 permit ip 192.168.1.0 0.0.0.255 10.10.0.0 0.0.255.255
!
interface Serial0/0
 crypto map HQ-MAP

! HQ
crypto isakmp policy 1
 encryption aes
 authentication pre-share
 group 2
 crypto isakmp key cisco123 address 209.165.200.242
!
crypto ipsec transform-set Branch-VPN esp-3des esp-sha-hmac
!
crypto map Branch-MAP 10 ipsec-isakmp
 set peer 209.165.200.242
 set transform-set Branch-VPN
 match address Branch-VPN-ACL
!
ip access-list extended Branch-VPN-ACL
 remark HQ to Branch traffic to trigger VPN
 10 permit ip 10.10.0.0 0.0.255.255 192.168.1.0 0.0.0.255
!
interface Serial0/0
 crypto map Branch-MAP

! b. Verifying IPsec VPN
!
! Branch
do sh crypto session detail

! c. Verifying connectivity btw Branch & HQ
!
! Branch
do pi 10.10.10.1 so 192.168.1.1

! d. Verifying VPN tunnel details
!
! Branch
do sh crypto session detail

! e. Disabling IPsec VPN
!
! Branch
do clear crypto isakmp

do clear crypto sa

!###################################
! Running Configuration
!
! Branch
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
!
crypto isakmp key cisco123 address 209.165.200.226
!
crypto ipsec transform-set HQ-VPN esp-3des esp-sha-hmac 
!
crypto map HQ-MAP 10 ipsec-isakmp 
 set peer 209.165.200.226
 set transform-set HQ-VPN 
 match address HQ-VPN-ACL
!
interface Loopback1
 description Branch LAN
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Serial0/0
 description Connection to ISP
 bandwidth 64
 ip address 209.165.200.242 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 clock rate 2000000
 crypto map HQ-MAP
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 209.165.200.241
!         
no ip http server
no ip http secure-server
ip nat pool BRANCH-NAT-POOL 209.165.200.249 209.165.200.254 prefix-length 29
ip nat inside source list BRANCH-NAT-ACL pool BRANCH-NAT-POOL
!
ip access-list extended BRANCH-NAT-ACL
 remark Do not translate Local LAN to HQ LAN addresses
 deny   ip 192.168.1.0 0.0.0.255 10.10.0.0 0.0.255.255
 remark Translate Local LAN to all other Internet destinations
 permit ip 192.168.1.0 0.0.0.255 any
ip access-list extended HQ-VPN-ACL
 remark Branch to HQ traffic to trigger VPN
 permit ip 192.168.1.0 0.0.0.255 10.10.0.0 0.0.255.255


! HQ
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
!
crypto isakmp key cisco123 address 209.165.200.242
!
crypto ipsec transform-set Branch-VPN esp-3des esp-sha-hmac 
!
crypto map Branch-MAP 10 ipsec-isakmp 
 set peer 209.165.200.242
 set transform-set Branch-VPN 
 match address Branch-VPN-ACL
!
interface Loopback0
 description HQ email server address
 ip address 10.10.20.238 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Loopback1
 description Headquarters LAN
 ip address 10.10.10.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Serial0/0
 description Connection to ISP
 bandwidth 64
 ip address 209.165.200.226 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 clock rate 64000
 crypto map Branch-MAP
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 209.165.200.225
!
no ip http server
no ip http secure-server
ip nat pool HQ-NAT-POOL 209.165.200.233 209.165.200.237 prefix-length 29
ip nat inside source list HQ-NAT-ACL pool HQ-NAT-POOL
ip nat inside source static 10.10.20.238 209.165.200.238
!
ip access-list extended Branch-VPN-ACL
 remark HQ to Branch traffic to trigger VPN
 permit ip 10.10.0.0 0.0.255.255 192.168.1.0 0.0.0.255
ip access-list extended HQ-NAT-ACL
 remark Do not translate HQ LAN to Branch LAN addresses
 deny   ip 10.10.0.0 0.0.255.255 192.168.1.0 0.0.0.255
 remark Translate Local LAN to all other Internet destinations
 permit ip 10.10.0.0 0.0.255.255 any


! ISP
interface Loopback1
 description Simulating the Internet
 ip address 209.165.202.129 255.255.255.240
!
interface Serial0/0
 description Connection to Branch
 bandwidth 64
 ip address 209.165.200.241 255.255.255.248
 clock rate 64000
!
interface Serial0/1
 description Connection to HQ
 bandwidth 64
 ip address 209.165.200.225 255.255.255.248
 clock rate 2000000
!
ip forward-protocol nd
ip route 209.165.200.232 255.255.255.248 Serial0/1
ip route 209.165.200.248 255.255.255.248 Serial0/0



! 4. Implement GRE over IPsec
! a. Configuring GRE tunnel btw HQ and Branch 
!
! Branch
interface Tunnel0
 ip address 172.16.100.2 255.255.255.252
 tunnel source 209.165.200.242
 tunnel destination 209.165.200.226

! HQ
interface Tunnel0
 ip address 172.16.100.1 255.255.255.252
 tunnel source 209.165.200.226
 tunnel destination 209.165.200.242

! b. Verifying tunnel interface
!
! Branch
do sh int tun0

! c. Verifying connectivity over GRE tunnel
!
! Branch
do pi 172.16.100.1

! d. Verifying traffic encryption
!
! Branch
do sh crypto session detail

! e. Configuring crypto ACL 
!
! Branch
no ip access-list extended HQ-VPN-ACL
ip access-list extended HQ-VPN-ACL
 remark HQ to Branch GRE traffic to trigger VPN
 permit gre host 209.165.200.242 host 209.165.200.226

! HQ
no ip access-list extended Branch-VPN-ACL
ip access-list extended Branch-VPN-ACL
 remark Branch to HQ GRE traffic to trigger VPN
 permit gre host 209.165.200.226 host 209.165.200.242

! f. Verifying connectivity
!
! Branch
do pi 172.16.100.1

! g. Verifying IPsec session
!
! Branch
do sh crypto session detail

! h. Verifying connectivity btw LANs
!
! Branch 
do pi 10.10.10.1 so 192.168.1.1

! i. Verifying routing table
!
! Branch
do sh ip rou

! j. Configuring EIGRP
!
! Branch
router eigrp 1
 network 192.168.1.0 0.0.0.255
 network 172.16.100.0 0.0.0.3

! HQ
router eigrp 1
 network 10.10.0.0 0.0.255.255
 network 172.16.100.0 0.0.0.3

! k. Verifying routing table
!
! Branch
do sh ip rou

! l. Verifying IPsec session
!
! Branch
do sh crypto session detail

! m. Verifying end-to-end connectivity and IPsec session
!
! Branch
do pi 10.10.10.1 so 192.168.1.1

! n. Tracing path from Branch LAN to enmail server
!
! Branch
do trace 10.10.20.238 so 192.168.1.1

! o. Proving Internet access w/o GRE tunnel
!
! Branch
do trace 209.165.200.238 so 192.168.1.1

!######################################
! Running Configuration
!
! Branch
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.226
!
crypto ipsec transform-set HQ-VPN esp-3des esp-sha-hmac 
!
crypto map HQ-MAP 10 ipsec-isakmp 
 set peer 209.165.200.226
 set transform-set HQ-VPN 
 match address HQ-VPN-ACL
!
interface Loopback1
 description Branch LAN
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Tunnel0
 ip address 172.16.100.2 255.255.255.252
 tunnel source 209.165.200.242
 tunnel destination 209.165.200.226
!
interface Serial0/0
 description Connection to ISP
 bandwidth 64
 ip address 209.165.200.242 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 clock rate 2000000
 crypto map HQ-MAP
!
router eigrp 1
 network 172.16.100.0 0.0.0.3
 network 192.168.1.0
 auto-summary
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 209.165.200.241
!
no ip http server
no ip http secure-server
ip nat pool BRANCH-NAT-POOL 209.165.200.249 209.165.200.254 prefix-length 29
ip nat inside source list BRANCH-NAT-ACL pool BRANCH-NAT-POOL
!
ip access-list extended BRANCH-NAT-ACL
 remark Do not translate Local LAN to HQ LAN addresses
 deny   ip 192.168.1.0 0.0.0.255 10.10.0.0 0.0.255.255
 remark Translate Local LAN to all other Internet destinations
 permit ip 192.168.1.0 0.0.0.255 any
ip access-list extended HQ-VPN-ACL
 remark HQ to Branch GRE traffic to trigger VPN
 permit gre host 209.165.200.242 host 209.165.200.226


! HQ
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.242
!
crypto ipsec transform-set Branch-VPN esp-3des esp-sha-hmac 
!
crypto map Branch-MAP 10 ipsec-isakmp 
 set peer 209.165.200.242
 set transform-set Branch-VPN 
 match address Branch-VPN-ACL
!
interface Loopback0
 description HQ email server address
 ip address 10.10.20.238 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Loopback1
 description Headquarters LAN
 ip address 10.10.10.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
!
interface Tunnel0
 ip address 172.16.100.1 255.255.255.252
 tunnel source 209.165.200.226
 tunnel destination 209.165.200.242
!
interface Serial0/0
 description Connection to ISP
 bandwidth 64
 ip address 209.165.200.226 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 clock rate 64000
 crypto map Branch-MAP
!
router eigrp 1
 network 10.10.0.0 0.0.255.255
 network 172.16.100.0 0.0.0.3
 auto-summary
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 209.165.200.225
!
no ip http server
no ip http secure-server
ip nat pool HQ-NAT-POOL 209.165.200.233 209.165.200.237 prefix-length 29
ip nat inside source list HQ-NAT-ACL pool HQ-NAT-POOL
ip nat inside source static 10.10.20.238 209.165.200.238
!         
ip access-list extended Branch-VPN-ACL
 remark Branch to HQ GRE traffic to trigger VPN
 permit gre host 209.165.200.226 host 209.165.200.242
ip access-list extended HQ-NAT-ACL
 remark Do not translate HQ LAN to Branch LAN addresses
 deny   ip 10.10.0.0 0.0.255.255 192.168.1.0 0.0.0.255
 remark Translate Local LAN to all other Internet destinations
 permit ip 10.10.0.0 0.0.255.255 any


! ISP
interface Loopback1
 description Simulating the Internet
 ip address 209.165.202.129 255.255.255.240
!
interface Serial0/0
 description Connection to Branch
 bandwidth 64
 ip address 209.165.200.241 255.255.255.248
 clock rate 64000
!
interface Serial0/1
 description Connection to HQ
 bandwidth 64
 ip address 209.165.200.225 255.255.255.248
 clock rate 2000000
!
ip forward-protocol nd
ip route 209.165.200.232 255.255.255.248 Serial0/1
ip route 209.165.200.248 255.255.255.248 Serial0/0


!#####################################################################
! Chapter 7 Example PPPoA
!
! File: RTR.Ch7-ex.PPPoA-01
!
! Procedures:
!  1. Configuring ATM interface
!  2. Configuring dialer interface
!  3. Configuring PAT
!  4. Configuring Branch router as local DHCP server
!  5. Configuring static route
!
!
! There is not appropriate mode can use to emulate the environment.  Following
! is sample configuration captured from the FLG Example 7-1.
!
hostname Branch

ip dhcp pool MY-POOL
 network 192.168.1.0 255.255.255.0
 default-router 192.168.1.1
!
interface ATM0/0
 no ip address
 dsl operating-mode auto
 pvc 8/35
  encapsulation aal5mux ppp dialer
  dialer pool-number 1
!
interface FastEthernet0/0
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
!
interface Dialer0
 ip address negotiated
 encapsulation ppp
 dialer pool 1
 inp nat outside
 ppp authentication chap callin
 ppp chap password mysecret
!
ip nat inside source list 101 interface Dialer0 overload
access-list 101 permit ip 192.168.1.0 0.0.0.255 any
!
ip route 0.0.0.0 0.0.0.0 Dialer0


!#####################################################################
! Chapter 7 Example Routing Facilities for Branch Office
!
! File: RTR.Ch7-ex.Branch.Routing-01
!
! Procedures:
!  1. Configuring network with connectivity
!  2. Configuring static routing
!    a. Routing to the Internet
!      1. Verifying protocol on Branch router
!      2. Verifying routes on Branch
!      3. Verifying protocol on the HQ router
!      4. Verifying routes on HQ router
!      5. Verifying connectivity to the HQ e-mail server
!      6. Verifying connectivity to the ISP website
!    b. Floating static route
!      1. Configuring a floating default static route on Banch
!      2. Observing the floating static route
!      3. Verifying the routing table
!      4. Trace from the Branch LAN to the e-mail server
!  3. Configuring PAT
!    a. Configuring NAT
!      1. Condfiguring access list for NAT
!      2. Creating NAT pool
!      3. Configuring dynamic NAT on the Branch router
!      4. Configuring static NAT on the Branch router
!      5. Issuing NAT on Branch router interface
!    b. Verifying NAT
!      1. Displying NAT
!      2. Displaying NAT statistics
!      3. Generating NAT traffic
!      4. Verifying NAT translations
!      5. Verifying static NAT translation on HQ
!      6. Verifying static NAT translation on Branch
!      7. Configuring final NAT on Branch
!  4. Verifying and tuning IPsec VPN
!    a. Configuring IPsec stat-to-state VPN on Branch
!    b. Verifying IPsec on Branch
!      1. Initiating IPsec VPN
!      2. Debuging NAT in IPsec VPN tunnel
!      3. Debugging NAT in an IPsec IPsec VPN tunnel
!      4. Altering the NAT ACL
!      5. Testing the VPN link
!      7. Clear the NAT translation and tesing VVPN link
!      8. Displaying crypto session information
!      9. Displaying crypto session with detail infromation
!     10. Displaying SA information
!  5. Configuring GRE tunnel
!    a. Disabling EIGRP
!    b. Creating tunnel interface on Branch router
!    c. Creating a loopback and tunel interfaces on HQ
!    d. Displaying tunnel interface on Branch
!    e. Replacing crypto ACL on Branch
!    f. Replacing crypto ACL on HQ
!    g. Activating GRE tunnel
!    h. Verifying IPsec VPN tunnel
!    i. Verifying LAN to LAN connectivity
!    j. Displaying routing table on Branch
!    k. Enabling EIGRP on Branch
!    l. Enabling EIGRP on HQ
!    m. Verifying EIGRP neighbor
!    n. Verifying EIGRP routing table
!    o. Verifying EIGRP routing table
!    p. Verifying IPsec VPN detail
!    q. Verifying Internet connectivity
!    r. Configuring final IPsec on Branch
!
!
! 1. Configuring network with connectivity
!
! Initial Configuration
!
! Branch
interface FastEthernet0/0
 ip address 192.168.1.1 255.255.255.0
 duplex auto
 speed auto
 no shutdown
!
interface Serial0/0
 ip address 172.16.1.2 255.255.255.252
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
interface Serial0/1
 ip address 209.165.200.242 255.255.255.248
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
router eigrp 1
 network 172.16.1.0 0.0.0.3
 network 192.168.1.0
! network 209.165.200.240 0.0.0.7
 no auto-summary
!
ip default-network 172.16.1.1
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 172.16.1.1
! ip route 172.16.0.0 255.255.0.0 172.16.1.1


! HQ
interface FastEthernet0/0
 ip address 10.10.10.1 255.255.255.0
 duplex auto
 speed auto
 no shutdown
!
interface Serial0/0
 ip address 172.16.1.1 255.255.255.252
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
interface Serial0/1
 ip address 209.165.200.226 255.255.255.248
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
router eigrp 1
 network 10.10.10.0 0.0.0.255
 network 172.16.1.0 0.0.0.3
! network 209.165.200.224 0.0.0.7
 no auto-summary
 redistribute static
!
ip default-network 0.0.0.0
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 Serial0/0
ip route 209.165.202.208 255.255.255.240 209.165.200.225

! the following commands indicates that the NAT for email server has 
! been setup in HQ router
!
! HQ
ip nat in so stat 10.10.10.238 209.165.200.238

int f0/0
 ip nat in

int s0/0
 ip nat out

int s0/1
 ip nat out


! ISP
interface FastEthernet0/0
 ip address 209.165.202.209 255.255.255.240
 duplex auto
 speed auto
 no shutdown
!
interface Serial0/0
 ip address 209.165.200.241 255.255.255.248
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
interface Serial0/1
 ip address 209.165.200.225 255.255.255.248
 encapsulation ppp
 clock rate 2000000
 no shutdown
!
ip route 209.165.200.224 255.255.255.240 209.165.200.226
ip route 209.165.200.240 255.255.255.240 209.165.200.242

!
! BR_Srv
hostname BR-Srv

int f0/0
 ip add 192.168.1.254 255.255.255.0
 no shut

ip route 0.0.0.0 0.0.0.0 f0/0

!
! Web-Srv
hostname Web_Srv

int f0/0
 ip add 209.165.202.211 255.255.255.240
 no shut

ip route 0.0.0.0 0.0.0.0 f0/0

!
! Email_Srv
hostname Email_Srv

int f0/0
 ip add 10.10.10.238 255.255.255.0
 no shut

ip route 0.0.0.0 0.0.0.0 f0/0

! 2. Configuring static routing
! a. Routing to the Internet
!   1. Verifying protocol on Branch router
!   2. Verifying routes on Branch
!   3. Verifying protocol on the HQ router
!   4. Verifying routes on HQ router
!   5. Verifying connectivity to the HQ e-mail server
!   6. Verifying connectivity to the ISP website
!
! Branch & HQ
do sh ip pro

do sh ip rou

! Branch
do pi 10.10.10.238 so 192.168.1.1

do tra 10.10.10.238 so 192.168.1.1


! The following two commands should not go through except for NAT 
! is implemented for Branch LAN
do pi 209.165.202.211 so 192.168.1.1

do tra 209.165.202.211 so 192.168.1.1

! b. Floating static route
!   1. Configuring a floating default static route on Banch
!   2. Observing the floating static route
!   3. Verifying the routing table
!   4. Trace from the Branch LAN to the e-mail server
!
! Branch
ip route 0.0.0.0 0.0.0.0 209.165.200.241 171

do deb ip rou

int s0/0
 shut

do un all

do sh ip rou

! default route for HQ when S0/0 is down
! 
! HQ
!
ip route 0.0.0.0 0.0.0.0 209.165.200.225 171

! Branch
! Book indicates that the ping success but it should not.  There is no
! route for 192.168.1.1 to return from HQ. Next section will provide 
! the translation of private LAN of Branch router.   
do pi 209.165.200.238 so 192.168.1.1

do tra 209.165.200.238 so 192.168.1.1

! 3. Configuring PAT
!  a. Configuring NAT
!   1. Condfiguring access list for NAT
!   2. Creating NAT pool
!   3. Configuring dynamic NAT on the Branch router
!   4. Configuring static NAT on the Branch router
!   5. Issuing NAT on Branch router interface
!
! Branch
ip acce ext BR_NAT_ACL
 10 per ip 192.168.1.0 0.0.0.255 any

! NAT pool commands: 
! ip nat pool BRANCH-NAT-POOL 209.165.200.249 209.165.200.253 net 255.255.255.248
! or
ip nat pool BR_NAT_POOL 209.165.200.249 209.165.200.253 pre 29

ip nat inside so list BR_NAT_ACL pool BR_NAT_POOL

ip nat inside so stat 192.168.1.254 209.165.200.254

int s0/0
 ip nat out

int s0/1
 ip nat out

int f0/0
 ip nat in

!
! HQ
ip nat pool HQ_NAT_POOL 209.165.200.233 209.165.200.237 pre 29
ip nat inside so list HQ_NAT_ACL pool HQ_NAT_POOL

ip nat inside so stat 10.10.10.238 209.165.200.238

ip acce ext HQ_NAT_ACL
 per ip  10.10.10.0 0.0.0.255 any

int f0/0
 ip nat in

int s0/0
 ip nat out

int s0/1
 ip nat out


! b. Verifying NAT
! 1. Displying NAT
!   2. Displaying NAT statistics
!   3. Generating NAT traffic
!   4. Verifying NAT translations
!   5. Verifying static NAT translation on HQ
!   6. Verifying static NAT translation on Branch
!   7. Configuring final NAT on Branch
!
! Branch
do sh ip nat tran

do sh ip nat stat

do deb ip nat

do clear ip nat tran *

do tel 209.165.200.226 /so f0/0

do sh ip nat tran

do sh ip nat stat

! HQ
do pi 209.165.200.254

! Branch
do sh ip nat tran

! Observing debug info on Branch


! 4. Verifying and tuning IPsec VPN
!   a. Configuring IPsec stat-to-state VPN on Branch & HQ
!
! Branch
crypto isakmp policy 1
 encryption aes
 authentication pre-share
 group 2

crypto isakmp key cisco123 address 209.165.200.226

crypto ipsec transform-set BR2HQ_VPN_SET esp-sha-hmac esp-3des

crypto map BR2HQ_VPN_MAP 10 ipsec-isakmp
 set transform-set BR2HQ_VPN_SET
 set peer 209.165.200.226
 match address BR2HQ_VPN_ACL

! access-list 110 per ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
ip acce ext BR2HQ_VPN_ACL
 10 per ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255

int s0/1
 crypto map BR2HQ_VPN_MAP

! HQ
crypto isakmp policy 1
 encryption aes
 authentication pre-share
 group 2

crypto isakmp key cisco123 address 209.165.200.242

crypto ipsec transform-set HQ2BR_VPN_SET esp-sha-hmac esp-3des

crypto map HQ2BR_VPN_MAP 10 ipsec-isakmp
 set transform-set HQ2BR_VPN_SET
 set peer 209.165.200.242
 match address HQ2BR_VPN_ACL

! access-list 110 per ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255
ip acce ext HQ2BR_VPN_ACL
 10 per ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255

int s0/1
 crypto map HQ2BR_VPN_MAP


! b. Verifying IPsec on Branch
!   1. Initiating IPsec VPN tunnel
!   2. Debuging NAT in IPsec VPN tunnel
!   3. Debugging NAT in an IPsec IPsec VPN tunnel
!   4. Altering the NAT ACL
!   5. Testing the VPN link
!   7. Clear the NAT translation and tesing VPN link
!   8. Displaying crypto session information
!   9. Displaying crypto session with detail infromation
!  10. Displaying SA information
!
! Branch
do deb crypto ipsec
do pi 10.10.10.0 so 192.168.1.1
do sh crypto session
do un all

do deb ip nat
do pi 10.10.10.1 so 192.168.1.1
do un all

do sh access-list

! b.4 
! Branch
no ip acce ext BR_NAT_ACL
ip acce ext BR_NAT_ACL
 10 deny ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
 20 per ip 192.168.1.0 0.0.0.255 any

! HQ 
no ip acce ext HQ_NAT_ACL
ip acce ext HQ_NAT_ACL
 10 deny ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255 
 20 per ip 10.10.10.0 0.0.0.255 any

! Branch
do pi 10.10.10.1 so 192.168.1.1

do sh ip nat tran

do clear ip nat tran *
do clear crypto isakmp
do clear crypto sa
do pi 10.10.10.1 so 192.168.1.1

do sh crypto session

do sh crypto session detail

do sh crypto ipsec sa

! Running Configuration
!
! Branch
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.226
!
crypto ipsec transform-set BR2HQ_VPN_SET esp-3des esp-sha-hmac 
!
crypto map BR2HQ_VPN_MAP 10 ipsec-isakmp 
 set peer 209.165.200.226
 set transform-set BR2HQ_VPN_SET 
 match address BR2HQ_VPN_ACL
!
interface FastEthernet0/0
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
 duplex auto
 speed auto
!
interface Serial0/0
 ip address 172.16.1.2 255.255.255.252
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 shutdown
 clock rate 2000000
!
interface Serial0/1
 ip address 209.165.200.242 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
 crypto map BR2HQ_VPN_MAP
!         
router eigrp 1
 network 172.16.1.0 0.0.0.3
 network 192.168.1.0
 no auto-summary
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 172.16.1.1
ip route 0.0.0.0 0.0.0.0 209.165.200.241 171
ip route 172.16.0.0 255.255.0.0 172.16.1.1
!
no ip http server
no ip http secure-server
ip nat pool BR_NAT_POOL 209.165.200.249 209.165.200.253 prefix-length 29
ip nat inside source list BR_NAT_ACL pool BR_NAT_POOL
ip nat inside source static 192.168.1.254 209.165.200.254
!
ip access-list extended BR2HQ_VPN_ACL
 permit ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
ip access-list extended BR_NAT_ACL
 deny   ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
 permit ip 192.168.1.0 0.0.0.255 any

! HQ
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.242
!
crypto ipsec transform-set HQ2BR_VPN_SET esp-3des esp-sha-hmac 
!
crypto map HQ2BR_VPN_MAP 10 ipsec-isakmp 
 set peer 209.165.200.242
 set transform-set HQ2BR_VPN_SET 
 match address HQ2BR_VPN_ACL
!
interface FastEthernet0/0
 ip address 10.10.10.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
 duplex auto
 speed auto
!
interface Serial0/0
 ip address 172.16.1.1 255.255.255.252
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
!
interface Serial0/1
 ip address 209.165.200.226 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
 crypto map HQ2BR_VPN_MAP
!
router eigrp 1
 redistribute static
 network 10.10.10.0 0.0.0.255
 network 172.16.1.0 0.0.0.3
 no auto-summary
!
ip default-network 0.0.0.0
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 Serial0/0
ip route 0.0.0.0 0.0.0.0 209.165.200.225 171
ip route 209.165.202.208 255.255.255.240 209.165.200.225
!
no ip http server
no ip http secure-server
ip nat pool HQ_NAT_POOL 209.165.200.233 209.165.200.237 prefix-length 29
ip nat inside source list HQ_NAT_ACL pool HQ_NAT_POOL
ip nat inside source static 10.10.10.238 209.165.200.238
!
ip access-list extended HQ2BR_VPN_ACL
 permit ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255
ip access-list extended HQ_NAT_ACL
 deny   ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255
 permit ip 10.10.10.0 0.0.0.255 any


! 5. Configuring GRE tunnel
!  a. Disabling EIGRP
!  b. Creating tunnel interface on Branch router
!
! Branch
no router eig 1
int tun0
 ip add 172.16.100.2 255.255.255.252
 tun so 209.165.200.242
 tun des 209.165.200.226

! c. Creating a loopback and tunel interfaces on HQ
!
! HQ
no router eig 1
int tun0
 ip add 172.16.100.1 255.255.255.252
 tun so 209.165.200.226
 tun des 209.165.200.242

! c. Displaying tunnel interface on Branch
!
! Branch
do sh int tun0

! c. Replacing crypto ACL on Branch
!
! Branch
no ip acces ext BR2HQ_VPN_ACL
ip acce ext BR2HQ_VPN_ACL
 10 per gre host 209.165.200.242 host 209.165.200.226

! f. Replacing crypto ACL on HQ
!
! HQ
no ip acce ext HQ2BR_VPN_ACL
ip acce ext HQ2BR_VPN_ACL
 10 per gre host 209.165.200.226 host 209.165.200.242

! g. Activating GRE tunnel
!
! Branch
do pi 172.16.100.1

! h. Verifying IPsec VPN tunnel
!
! Branch
do sh crypto sess det

! i. Verifying LAN to LAN connectivity
!
! Branch
do pi 10.10.10.1 so 192.168.1.1

! j. Displaying routing table on Branch
!
! Branch
do sh ip rou

! k. Enabling EIGRP on Branch
!
! Branch
router eig 1
 net 192.168.1.0 0.0.0.255
 net 172.16.100.0 0.0.0.3
 no au

! to add the private WAN, net 172.16.1.0 0.0.0.3

! l. Enabling EIGRP on HQ
!
! HQ
router eig 1
 net 10.10.10.0 0.0.0.255
 net 172.16.100.0 0.0.0.3
 no au

! m. Verifying EIGRP neighbor
!
! Branch
do sh ip eig nei

! n. Verifying EIGRP routing table
!
! Branch
do sh ip rou eig 1

! o. Verifying EIGRP routing table
!
! Branch
do pi 10.10.10.1 so 192.168.1.1

do tra 10.10.10.1 so 192.168.1.1

! p. Verifying IPsec VPN detail
!
! Branch
do sh crypto sess det

! q. Verifying Internet connectivity
!
! Branch
do tra 209.165.200.226 so 192.168.1.1

! r. Configuring final IPsec on Branch
!
! Branch
int tun0
 ip add 172.16.100.2 255.255.255.252
 tun so 209.165.200.242
 tun des 209.165.200.226
ex

no acce 110
acce 110 per gre host 209.165.200.242 host 206.165.200.226

router eig 1
 net 192.168.1.0 0.0.0.255 
 net 172.16.100.0 0.0.0.3
 no au


!
! The "%TUN-5-RECURDOWN" Error Message and Flapping EIGRP/OSPF/BGP 
! Neighbors Over a GRE Tunnel http://www.cisco.com/c/en/us/support/docs/ip/enhanced-interior-gateway-routing-protocol-eigrp/22327-gre-flap.html
!

!#####################################
! Running Configuration
!
! Branch
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.226
!
crypto ipsec transform-set BR2HQ_VPN_SET esp-3des esp-sha-hmac 
!
crypto map BR2HQ_VPN_MAP 10 ipsec-isakmp 
 set peer 209.165.200.226
 set transform-set BR2HQ_VPN_SET 
 match address BR2HQ_VPN_ACL
!
interface Tunnel0
 ip address 172.16.100.2 255.255.255.252
 tunnel source 209.165.200.242
 tunnel destination 209.165.200.226
 crypto map BR2HQ_VPN_MAP
!         
interface FastEthernet0/0
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
 duplex auto
 speed auto
!
interface Serial0/0
 ip address 172.16.1.2 255.255.255.252
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 shutdown
 clock rate 2000000
!
interface Serial0/1
 ip address 209.165.200.242 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
 crypto map BR2HQ_VPN_MAP
!
router eigrp 1
 network 172.16.100.0 0.0.0.3
 network 192.168.1.0
 no auto-summary
!
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 172.16.1.1
ip route 0.0.0.0 0.0.0.0 209.165.200.241 171
ip route 172.16.0.0 255.255.0.0 172.16.1.1
!
no ip http server
no ip http secure-server
ip nat pool BR_NAT_POOL 209.165.200.249 209.165.200.253 prefix-length 29
ip nat inside source list BR_NAT_ACL pool BR_NAT_POOL
ip nat inside source static 192.168.1.254 209.165.200.254
!         
ip access-list extended BR2HQ_VPN_ACL
 permit ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
ip access-list extended BR_NAT_ACL
 deny   ip 192.168.1.0 0.0.0.255 10.10.10.0 0.0.0.255
 permit ip 192.168.1.0 0.0.0.255 any

! HQ
crypto isakmp policy 1
 encr aes
 authentication pre-share
 group 2
crypto isakmp key cisco123 address 209.165.200.242
!
crypto ipsec transform-set HQ2BR_VPN_SET esp-3des esp-sha-hmac 
!
crypto map HQ2BR_VPN_MAP 10 ipsec-isakmp 
 set peer 209.165.200.242
 set transform-set HQ2BR_VPN_SET 
 match address HQ2BR_VPN_ACL
!
interface Tunnel0
 ip address 172.16.100.1 255.255.255.252
 tunnel source 209.165.200.226
 tunnel destination 209.165.200.242
 crypto map HQ2BR_VPN_MAP
!         
interface FastEthernet0/0
 ip address 10.10.10.1 255.255.255.0
 ip nat inside
 ip virtual-reassembly
 duplex auto
 speed auto
!
interface Serial0/0
 ip address 172.16.1.1 255.255.255.252
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
!
interface Serial0/1
 ip address 209.165.200.226 255.255.255.248
 ip nat outside
 ip virtual-reassembly
 encapsulation ppp
 clock rate 2000000
 crypto map HQ2BR_VPN_MAP
!
router eigrp 1
 network 10.10.10.0 0.0.0.255
 network 172.16.100.0 0.0.0.3
 no auto-summary
!
ip default-network 0.0.0.0
ip forward-protocol nd
ip route 0.0.0.0 0.0.0.0 Serial0/0
ip route 0.0.0.0 0.0.0.0 209.165.200.225 171
ip route 209.165.202.208 255.255.255.240 209.165.200.225
!
no ip http server
no ip http secure-server
ip nat inside source list HQ_NAT_ACL pool HQ_NAT_POOL
ip nat inside source static 10.10.10.238 209.165.200.238
!
ip access-list extended HQ2BR_VPN_ACL
 permit ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255
ip access-list extended HQ_NAT_ACL
 deny   ip 10.10.10.0 0.0.0.255 192.168.1.0 0.0.0.255
 permit ip 10.10.10.0 0.0.0.255 any

! ISP
interface FastEthernet0/0
 ip address 209.165.202.209 255.255.255.240
 duplex auto
 speed auto
!
interface Serial0/0
 ip address 209.165.200.241 255.255.255.248
 encapsulation ppp
 clock rate 2000000
!
interface Serial0/1
 ip address 209.165.200.225 255.255.255.248
 encapsulation ppp
 clock rate 2000000
!
ip forward-protocol nd
ip route 209.165.200.224 255.255.255.240 209.165.200.226
ip route 209.165.200.240 255.255.255.240 209.165.200.242



!#####################################################################
! Chapter 7 Example Easy VPN - VPN Headend
!
! File: RTR.Ch7-ex.EZVPN-01
!
! Procedures:
!  1. Configuring network with connectivity and basic config
!  2. Allowing IPsec traffic
!    a. Verifying interface on R1
!    b. Verifying access list on R1
!    c. Verifying interface inspection on R1
!    d. Verifying zone-pair security on R1
!    e. Modifying ACL on R1 to support IPsec protocols
!  3. Defining afddress pool
!  4. Providing routing service for VPN subnets
!    a. Configuring static route and redistribution
!    b. Looking at the R2 routing table following redistribution
!        of the static route
!  5. Tuning NAT for VPN traffic flow
!    a. Verifying NAT statistics
!    b. Configuring VON user traffic to bypass address translation
!  6. Verifying IPsec VPN configuration
!    a. Verifying IPsec
!    b. Verifying crypto map
!    c. Verifying ISAKMP SA
!    d. Verifying crypto session
!    e. Verifying crypto engine
!    f. Routing table on the Branch router with the remote VPN client
!    g. Removing static route and configuring RRI
!
!
! 1. Configuring network with connectivity and basic config
!
! R1
!
int f0/0
 ip add 192.168.1.1 255.255.255.0
 ip access-group FIREWALL_INBOUND in
 ip nat out
 no shut

int f0/1
 ip add 10.7.7.1 255.255.255.0
 no shut

int f1/0
 ip add 10.6.6.1 255.255.255.0
 no shut

ip access-list extended FIREWALL_INBOUND
 10 permit eigrp any any 
 20 permit tcp any any eq telnet
 30 permit icmp any any 
 40 permit tcp any host 192.168.1.10 eq www
 50 permit tcp any host 192.168.1.10 eq ftp
 60 permit udp any any eq domain

ip access-list extended NAT_ACL
 10 permit ip 10.6.6.0 0.0.0.255 any

ip access-list extended SPLIT
 10 permit ip 10.6.6.0 0.0.0.255 172.31.7.0 0.0.0.255
 20 deny ip any any

! R2
!
int lo0
 ip add 10.200.200.1 255.255.255.0
 
int f0/0
 ip add 10.7.7.2 255.255.255.0
 no shut

! Server - Linux
!
ifconfig eth0 10.6.6.254 netmask 255.255.255.0 
route add default gw 10.6.6.1 eth0

! Addr_Pool
1
ip 192.168.1.2 255.255.255.0 192.168.1.1


! 2. Allowing IPsec traffic
!   a. Verifying interface on R1
!   b. Verifying access list on R1
!   c. Verifying interface inspection on R1
!   d. Verifying zone-pair security on R1
!   e. Modifying ACL on R1 to support IPsec protocols
!
! R1
end

sh ip int f0/0

sh access-list

sh ip inspect int

sh zone-pair sec

conf t
ip acce ext FIREWALL_INBOUND
 4 per 50 any any 
 5 per 51 any any
 6 per udp any any eq 500
 7 per udp any any eq 4500

! 3. Defining afddress pool
!
! R1
ip local pool EZVPN_POOL 10.254.254.1 10.254.254.254

! 4. Providing routing service for VPN subnets
!   a. Configuring static route and redistribution
!   b. Looking at the R2 routing table following redistribution
!       of the static route
!
! R1
ip route 10.254.254.0 255.255.255.0 192.168.1.2

do sh ip pro

do sh ip route

! 5. Tuning NAT for VPN traffic flow
!   a. Verifying NAT statistics
!   b. Configuring VPN user traffic to bypass address translation
!
! R1
do sh ip nat stat

access-list 100 deny ip any 10.254.254.0 0.0.0.255
access-list 100 permit ip any any

route-map VPNTRAFFIC per 10
 match ip add 100
 exit

! 6. Verifying IPsec VPN configuration
!   a. Verifying crypto map
!   b. Verifying ISAKMP SA
!   c. Verifying crypto session
!   d. Verifying crypto engine
!   e. Routing table on the Branch router with the remote VPN client
!   f. Removing static route and configuring RRI
! 
! R1
do sh cry map

do sh cry isakmp sa

do sh cry sess det

do sh cry eng

do sh ip route static

no ip route 10.254.254.0 255.255.255.0

crypto dynamic-map DYNO 10
 reverse-route
 
do sh ip route static

