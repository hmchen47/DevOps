# Layer 2 Authentication - MAB

## 802.1X, MAB, and EAP Overview

+ 802.1x vs MAB
    + 802.1x:
        + a flexible L2 authentication method
        + using EAP protocols, tunneld by the switch inside RADIUS pkts
        + client and switch perform EAP regonitation
        + happen before being assigned an IP addr via DHCP
    + MAB (MAC Authetication Bypass)
        + autheticate non-802.1x capable devices
        + trigger CWA, CPP, and BYOD enrollment
        + Simple L2 authetication method
            + no negotiation btw client and switch
            + switch takes each newly learned MAC addr & sends to RADIUS for authentication
        + client no capable of negotiation w/ switch or wireless controller for RADIUS validation
        + RADIUS pkts contains:
            + RADIUS Username: MAC
            + RADIUS Password: MAC
            + Calling Station ID: MAC (substitute username & password)
            + Server Type: CALL-CHECK
        + Depening on RADIUS server config, MAB authetication
            + done based on the Call-Station-Id value -> no fake username/password in ISE db
            + otherwise, username/password authentication via PAP/MD5 performaed

+ Network Topology
    <br/><img src="./diagrams/802.1x-MAB-EAP.png" alt="Network Topology" width="600">
    + Devices
        + Supplicant: Test PC A
        + Authenticaor (NAD): SW1
        + Authentication Server: ISE-1
        + Non-802.1x device: IP Phone
    + Protocols: 
        + Supplicant <-> NAD: EAP
        + NAD <-> Authentication Server: RADIUS
        + IP Phone <-> SW1: MAB

+ EAP Types (Extensible Authentication Protoxol)
    + EAP-TLS
        + One phase protocol
        + Mutual authentication based on certificates
        + Client & server certificates required
        + No identity protection - clear text
    + PEAP (Protected EAP)
        + Two phase protocol
            + Phase 1: outer method, authenticate server and form the TLS channel
            + Phase 2: inner method, authenticate client and protect client identity
        + Mutual authentication
            + Server always authenticated by certifiate
            + Client authentication: certificate (EAP-TLS)
            + Theoretically, inner authentication method could be any EAP type
        + Identity protection only in TLS cnannel negotitation -> phase 2, after TLS channel negotitated
        + E.g., Windows > Network Adaptor > <any item> > Properties > Authentication > 802.1x enable > Settings
    + EAP-FAST (Flexible Authentication via Secure Tunneling)
        + Cisco proprietary
            + Allow fast re-authentication and wireless roaming
            + Windows NOT supported
        + Based on PAC file (Protected Access Credentuial)
            + Seen as a cookie locally on the client after authentication
            + Generated by RADIUS server from a master key known by itself only
        + Three-phases process
            + Phase 0: optional, provisioning the client w/ a PAC file
                + Using EAP-MASHAPSv2 or EAP-GTC
                + Once successful, client not yet authenticated
            + Phase 1: establish TLS tunnel based on the PAC file
            + Phase 2: autheticate the client within the TLS tunnel (EAP-TLS, EAP-MSCHAPSv2, EAP-GTC)
    + EAP-FASTv2 (EAP-Channing)
        + Tie machine authentication to user authentication
            + Scalable alternative to MAR (Machine Access Restriction)
            + Relies on machine PAC and user PAC
            + Perform double authetication within single EAP transaction
        + Flow: PC -Supplicant, SW - Authenticator, ISE - Authentication Server
            1. PC - EAP (M) -> SW <- RADIUS -> ISE
            2. PC <- PAC (M) - SW <- RADIUS -> ISE
            3. PC - EAP (U) [PAC(M)) + PAC(U)] <- RADIUS -> ISE
        + Will become standard, known as EAP-TEAP
    + EAP-TTLS (Tunnel TLS)
        + Very similar with PEAP: two-phases protocol
        + Not supported by Windows
        + Not widely implemented
        + Major advantage: inner method uses any authentication mechanism, including non-EAP such as PAP and CHAP
    + EAP-MD5
        + Only user authentication based on username/password
        + Challenge-response through MD5
    + EAP-LEAP (Light EAP)
        + Cisco proprietary
        + Used only for wireless (WEP or TKip keys)
        + Weak mutual authentication based on shared screte (client's password)
        + Modified version of MS-CHAPS -> challenge-response based
        + Client authentication based on username/password


<a href="uhttps://www.youtube.com/watch?v=HcsVXH9RXZQrl" alt="069 802 1x, MAB, EAP Overview" target="_blank">
  <img src="http://files.softicons.com/download/system-icons/windows-8-metro-invert-icons-by-dakirby309/png/64x64/Folders%20&%20OS/My%20Videos.png" alt="Video" width="60px"> 
</a>

## [IEEE 802.1X](https://en.wikipedia.org/wiki/IEEE_802.1X)

+ IEEE Standard for port-based Network Access Control (PNAC)
+ An authentication mechanism to devices wishing to attach to a LAN or WLAN
+ Defines the encapsulation of EAPOL
+ "EAP over LAN" or EAPOL: Extensible Authentication Protocol (EAP) over IEEE 802
    + Originally designed for IEEE 802.3 Ethernet in 802.1X-2001
    + Used for other IEEE 802 LAN technologies such as IEEE 802.11 wireless and Fiber Distributed Data Interface (ISO 9314-2)
    + Modified for use with IEEE 802.1AE (“MACsec”) and IEEE 802.1AR (Secure Device Identity, DevID)

### Overview

+ Three parties: a supplicant, an authenticator, and an authentication server.
    + __supplicant__: a client device (such as a laptop) that wishes to attach to the LAN/WLAN. 
    + __authenticator__: a network device, such as an Ethernet switch or wireless access point
    + __authentication server__: typically a host running software supporting the RADIUS and EAP protocols.
        <br/><img src="https://upload.wikimedia.org/wikipedia/commons/1/1f/802.1X_wired_protocols.png" alt="EAP data is first encapsulated in EAPOL frames between the Supplicant and Authenticator, then re-encapsulated between the Authenticator and the Authentication server using RADIUS or Diameter." width="400">

+ Protocol operation
    + Port entities
        + 802.1X-2001
            + Two logical port entities for an authenticated port—the "controlled port" and the "uncontrolled port"
            + __Controlled port__: manipulated by the 802.1X PAE (Port Access Entity) to allow (in the authorized state) or prevent (in the unauthorized state) network traffic ingressing and egressing to/from the controlled port
            + __Uncontrolled port__: used by the 802.1X PAE to transmit and receive EAPOL frames
        + 802.1X-2004
            + Define the equivalent port entities for the supplicant
            + May prevent higher level protocols being used if it is not content that authentication has successfully completed
            + Useful when an EAP method providing mutual authentication is used
    + Typical authentication progression
        <br/><img src="https://upload.wikimedia.org/wikipedia/commons/1/17/802-1X.png" alt="Sequence diagram of the 802.1X progression" width="400">
        1. Initialization: 
            + New supplicant detected, the port on switch (authenticator) enabled and set to "unauthorized" state
            + Only 802.1X traffic allowed, other pkts dropped
        2. Initiation:
            + authenticator periodically transmiting EAP-Request Identity frames to a special Layer 2 address (01:80:C2:00:00:03) on the local network segment
            + supplicant listens on this address
            + on receipt of the EAP-Request Identity frame responding with an EAP-Response Identity frame containing an identifier for the supplicant such as a User ID
            + authenticator encapsulates this Identity response in a RADIUS Access-Request packet and forwards it on to the authentication server
            + supplicant may also initiate or restart authentication by sending an EAPOL-Start frame to the authenticator, which will then reply with an EAP-Request Identity frame.
        3. Negotiation (Technically _EAP negotiation_)
            + authentication server sends a reply (encapsulated in a RADIUS Access-Challenge packet) to the authenticator, containing an EAP Request specifying the EAP Method (The type of EAP based authentication it wishes the supplicant to perform)
            + authenticator encapsulates the EAP Request in an EAPOL frame and transmits it to the supplicant
            + supplicant:
                + Accept: using the requested EAP Method
                + NAK ("Negative Acknowledgement"): responding with the EAP Methods willing to perform
        4. Authentication
            + Once agreed on EAP method, EAP Requests and Responses between the supplicant and the authentication server (translated by the authenticator) until the authentication server responds with either an EAP-Success message (encapsulated in a RADIUS Access-Accept packet), or an EAP-Failure message (encapsulated in a RADIUS Access-Reject packet)
            + Successful: authenticator sets the port to the "authorized" state
            + Failed: emails in the "unauthorized" stat
            + supplicant logoff: send an EAPOL-logoff message to the authenticator & set port as "unauthorized" state


## [Extensible Authentication Protocol (EAP)](https://en.wikipedia.org/wiki/Extensible_Authentication_Protocol)

+ An authentication framework frequently used in wireless networks and point-to-point connections
+ Defined in RFC 3748 and updated by RFC 5247
+ Providing the transport and usage of keying material and parameters generated by EAP methods
+ Not a wire protocol but only defined message formats
+ Using EAP to define a way to encapsulate EAP messages within that protocol messages


## Network Access Authentication

+ Layer 2
    + Supplicant does not need an IP address
    + MAB and 802.1x (EAP methods)
+ Layer 3
    + Supplicant requires an IP address
    + Local Web Authentication (web portal on the NAD)
    + Central Web Authentication (web portal on the authentication server)

## MAB – MAC Authentication Bypass

+ MAB (MAC Authentication Bypass) is used to…
    + Authenticate non 802.1x capable devices
    + Trigger CWA and BYOD enrollment
    + Technically is NOT an authentication method…just bypasses authentication
+ If MAB is enabled on the switch interface
    + Switch takes each new MAC address and sends it to RADIUS for authentication
        + RADIUS User- Name and RADIUS User-Password equals to the MAC address
        + RADIUS Calling-Station-ID equals to the MAC address
        + RADIUS Service Type is Call-Check (10) for MAB

+ If “Process Host Lookup” is enabled on RADIUS server
    + Authentication is done based on the RADIUS Calling-Station-ID attribute value
+ If “Process Host Lookup” is disabled on RADIUS server
    + Authentication is done based on the RADIUS User-Name and User-Password attributes value

## MAB Configuration Steps on Supplicant

+ Not Required, due to
    + Because MAB is not a authentication protocol
    + It is authentication bypass
    + There is no negotiation between supplicant and NAD

## MAB Configuration Steps on NAD

+ Enable AAA: `aaa new-model`
+ Configure dot1x default authentication list: `aaa authentication dot1x default group`
+ Enable MAB on switch port facing the supplicant: `mab [eap]`
+ Enforce authentication on switch port facing the supplicant: `authentication port-control auto`
+ Define RADIUS server settings: `radius-server host <IP> key <radius key>`
+ Optionally configure other global/interface level settings: `radius-server attribute 31 mac format`

## MAB Configuration Steps on ISE

+ Configure MAB authentication policy
    + Optionally use a default one
+ Configure authorization policy
    + Optionally use a default one
+ Add supplicant’s MAC address into Internal Endpoints Store
    + Authentication performed based on RADIUS Calling Station-ID attribute value

## MAB Verification and Troubleshooting

+ Verification
    + `show mab all`
    + `show authentication session`
    + `show aaa servers`
+ Troubleshooting
    + `show authentication session interface <if>`
    + `debug mab all`
    + `debug radius authentication`

## MAB and 802.1x Common Authorizations

+ VLAN
    + Data VLAN (by name or number)
    + Optional, it overrides the VLAN locally configured on NAD switch port
    + Voice VLAN permission
    + Mandatory for voice domain, allows Phone to join the voice VLAN as configured locally on NAD

## MAB and EAP Common Authorizations

+ Access-Lists
    + dACL (Cisco Proprietary, uses AV pairs)
        + Before 12.2(55)SE code, switch port required a pre-auth ACL to be applied
        + ACL configured on ISE
    + Filter-ID ACL (IETF standard)
        + ACL configured on NAD
    + Per-user ACL (Cisco proprietary, uses AV pairs)
        + ACL configured on ISE and ACE’s pushed through authorization by ISE
        + ACL configured on NAD and ACL name pushed through authorization by ISE
+ ACL Common configuration requirements on NAD
    + `aaa authorization network default group`
    + `dACL also needs radius-server vsa send authentication`
    + `ip device tracking`

## Authorization Verification Troubleshooting

+ Verification
    + `show ip access-list interface <if_number>`
    + `show ip interface <if_number>`
    + `show epm session interface <if_number>`
    + `show authentication interface <if_number>`
    + `show authentication session interface <if_number>`
+ Troubleshooting
    + `show ip device tracking all`
    + `show aaa method-lists authorization`
    + `debug radius authentication`
    + `debug ip device tracking events`

## ISE MAB Authentication

<a href="https://youtu.be/nazpNmmU2Ys" alt="CCIE Security v4 ATC : ISE MAB Authentication" target="_blank">
  <img src="http://files.softicons.com/download/system-icons/windows-8-metro-invert-icons-by-dakirby309/png/64x64/Folders%20&%20OS/My%20Videos.png" alt="Video" width="60px"> 
</a>

+ MAB Config
    + Enable AAA: `aaa new-model`
    + Define RADIUS server settings: IP addr/hostname, port, etc.
    + Config dot1x default authentication list: `aaa authentication dot1x default group`
    + Enable  MAB on the port: `mab [eap]`
    + Enforce port authentication: `authentication port-control auto`
    + Optionally config other global/port settings

+ Lab topology
    <br/><img src="diagrams/mab-ccie.png" alt="Network Topology" width="600">
    + Client: R2
    + Autheticator/NAD: SW1
    + Authentication Server: ISE-1

+ Authetication Process - Basic
    + Authenticator, NAD: SW1 config
        ```cfg
        config terminal
        inf f1/0/2
          switchport access vlan29
          switchport mode access
          spanning-tree portfast
        exit
        aaa new-mo0del
          aaa group server radius ISE_RADIUS
          server private 172.16.1.100 key cisco
          ip radius source -interface loopback 0
        exit
        aaa authentication dot1x default group ISE_RADIUS
        do show cdp neighbor    ! R2 f1/0/2
        do show mac address-table dynamic int f1/0/2    ! get MAC addr d867.d9e0.bbc0
        ```
    + ISE Config
        + Adminstration > Network Resources / Network Devices > manually/default
        + Default mechanism: ISE received inbound radius request
            + lookup  network device session to authenticate
            + otherwise, fallback to default device
        + Manually add: Network Devices > Add: Name=sw1; ip addr=150.1.9.1/32; authentication settings=shared secret: cisco
        + Administration > Identity Management > Identities > Endpoints > Add: MAC Addr=d8:67:d9:e0:bb:c0
        + Policy > Authentication: MAB, Wired_MAB
            + Results: Allowed Protocols, un-check protocols
            + Create new results on Authentication > Allowed Protocols > Add: Name=MAB; check the followings: ProcessHost Lookup only (using MAC address); Allowed Protocols=(Allowed Protocols: MAB); use=Internal Endpoints
        + Policy > Authorization > Authorization Policy
            + Wired Black List Default=Black List AND Wireless 802.1x
            + Profiled Cisco IP Phones=Cisco IP-Phone
            + Default=PermitAccess
    + Verification on SW1
        + `show mac address-table dynamic int f1/0/2` -> nothing shown
        + `show mac address-table int f1/0/2` -> d867.d9e0.bbc0 STATIC
        + `show authentication sessions` -> Summary w/ SID
        + `show authentication sessions int f1/0/2` -> messages for MAC addr, user-Name, Sattus, Authorized by, Method, State
        + `show mab all`
    + Verification on ISE-1: Operations > Authentications > Entry (for detail)

+ Authentication with Username & Password
    + ISE-1: using MAC address as username
        + Administration > Identity Management / Identities > Users > Add: Name=d867d9e0bbc0 (not allowed by default)
        + Adminstration > Settings > User Password Policy:
            + disable username & password not the same
            + disable contain uppercase Alphabetic characters
    + ISE-1 Policy Results > Authentication > Allowed Protocols > MAB: 
        + disable Process Host Lookup
        + enable Allow:PAP/ASCII
    + SW1: `clear authentication sessions session-id <sid>
    + ISE-1 Verification: Operations > Authentications - failed entry shown
    + ISE-1: Policy > Authetication > MAB Entry: use=Internal Users
    + SW1: 
        + `show authetication sessions` -> failed
        + `clear authentication sessions session-id <sid>` -> trigger to re-authenticate
        + `show autheentication session int f1/0/2`
    + ISE Verification: Operations > Authentication > Entry details

+ Authentication with Frame (Previous Call Check)
    + ISE-1: Policy > Results > Authentication > MAB: 
        + enable Allow WAP MD5
        + disable Allow EAP-MD5 as Host Lookup
        + Valling Station ID & EAP-MD5 both working
    + SW1:
        ```cfg 
        show authetication sessions     ! get <sid>
        clear authentication sessions session-id <sid>  ! success but not what we want
        conf t
        int f1/0/2
          mab eap
        exit
        do show authentication sessions ! get <sid>
        do clear authetication sessions session-id <sid>
        do show mab all     ! mab eap used
        ```
    + Verification from ISE-1: 
        + Operations > Authentications > Entry detail selected: EAP-MD5 (use service type of frame, not service type of call check)
        + Policy > Authentications: 1st rule - Wired_MAB user Internal Users
        + Policy > Condiitions > Authentications > Compond Conditions > Wired_802.1x: Service TYpe=Framedl NAS-Port-TYpe=Ethernet


         







