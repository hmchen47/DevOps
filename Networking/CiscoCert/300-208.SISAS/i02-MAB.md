# Layer 2 Authentication - MAB

## 802.1X, MAB, and EAP Overview

+ 802.1x vs MAB
    + 802.1x:
        + a flexible L2 authentication method
        + using EAP protocols, tunneld by the switch inside RADIUS pkts
        + client and switch perform EAP regonitation
        + happen before being assigned an IP addr via DHCP
    + MAB (MAC Authetication Bypass)
        + autheticate non-802.1x capable devices
        + trigger CWA, CPP, and BYOD enrollment
        + Simple L2 authetication method
            + no negotiation btw client and switch
            + switch takes each newly learned MAC addr & sends to RADIUS for authentication
        + client no capable of negotiation w/ switch or wireless controller for RADIUS validation
        + RADIUS pkts contains:
            + RADIUS Username: MAC
            + RADIUS Password: MAC
            + Calling Station ID: MAC (substitute username & password)
            + Server Type: CALL-CHECK
        + Depening on RADIUS server config, MAB authetication
            + done based on the Call-Station-Id value -> no fake username/password in ISE db
            + otherwise, username/password authentication via PAP/MD5 performaed

+ Network Topology
    <br/><img src="./diagrams/802.1x-MAB-EAP.png" alt="Network Topology" width="600">
    + Devices
        + Supplicant: Test PC A
        + Authenticaor (NAD): SW1
        + Authentication Server: ISE-1
        + Non-802.1x device: IP Phone
    + Protocols: 
        + Supplicant <-> NAD: EAP
        + NAD <-> Authentication Server: RADIUS
        + IP Phone <-> SW1: MAB

+ EAP Types (Extensible Authentication Protoxol)
    + EAP-TLS
        + One phase protocol
        + Mutual authentication based on certificates
        + Client & server certificates required
        + No identity protection - clear text
    + PEAP (Protected EAP)
        + Two phase protocol
            + Phase 1: outer method, authenticate server and form the TLS channel
            + Phase 2: inner method, authenticate client and protect client identity
        + Mutual authentication
            + Server always authenticated by certifiate
            + Client authentication: certificate (EAP-TLS)
            + Theoretically, inner authentication method could be any EAP type
        + Identity protection only in TLS cnannel negotitation -> phase 2, after TLS channel negotitated
        + E.g., Windows > Network Adaptor > <any item> > Properties > Authentication > 802.1x enable > Settings
    + EAP-FAST (Flexible Authentication via Secure Tunneling)
        + Cisco proprietary
            + Allow fast re-authentication and wireless roaming
            + Windows NOT supported
        + Based on PAC file (Protected Access Credentuial)
            + Seen as a cookie locally on the client after authentication
            + Generated by RADIUS server from a master key known by itself only
        + Three-phases process
            + Phase 0: optional, provisioning the client w/ a PAC file
                + Using EAP-MASHAPSv2 or EAP-GTC
                + Once successful, client not yet authenticated
            + Phase 1: establish TLS tunnel based on the PAC file
            + Phase 2: autheticate the client within the TLS tunnel (EAP-TLS, EAP-MSCHAPSv2, EAP-GTC)
    + EAP-FASTv2 (EAP-Channing)
        + Tie machine authentication to user authentication
            + Scalable alternative to MAR (Machine Access Restriction)
            + Relies on machine PAC and user PAC
            + Perform double authetication within single EAP transaction
        + Flow: PC -Supplicant, SW - Authenticator, ISE - Authentication Server
            1. PC - EAP (M) -> SW <- RADIUS -> ISE
            2. PC <- PAC (M) - SW <- RADIUS -> ISE
            3. PC - EAP (U) [PAC(M)) + PAC(U)] <- RADIUS -> ISE
        + Will become standard, known as EAP-TEAP
    + EAP-TTLS (Tunnel TLS)
        + Very similar with PEAP: two-phases protocol
        + Not supported by Windows
        + Not widely implemented
        + Major advantage: inner method uses any authentication mechanism, including non-EAP such as PAP and CHAP
    + EAP-MD5
        + Only user authentication based on username/password
        + Challenge-response through MD5
    + EAP-LEAP (Light EAP)
        + Cisco proprietary
        + Used only for wireless (WEP or TKip keys)
        + Weak mutual authentication based on shared screte (client's password)
        + Modified version of MS-CHAPS -> challenge-response based
        + Client authentication based on username/password


<a href="uhttps://www.youtube.com/watch?v=HcsVXH9RXZQrl" alt="069 802 1x, MAB, EAP Overview" target="_blank">
  <img src="http://files.softicons.com/download/system-icons/windows-8-metro-invert-icons-by-dakirby309/png/64x64/Folders%20&%20OS/My%20Videos.png" alt="Video" width="60px"> 
</a>

## [Extensible Authentication Protocol (EAP)](https://en.wikipedia.org/wiki/Extensible_Authentication_Protocol)

+ An authentication framework frequently used in wireless networks and point-to-point connections
+ Defined in RFC 3748 and updated by RFC 5247
+ Providing the transport and usage of keying material and parameters generated by EAP methods
+ Not a wire protocol but only defined message formats
+ Using EAP to define a way to encapsulate EAP messages within that protocol messages


## Network Access Authentication

+ Layer 2
    + Supplicant does not need an IP address
    + MAB and 802.1x (EAP methods)
+ Layer 3
    + Supplicant requires an IP address
    + Local Web Authentication (web portal on the NAD)
    + Central Web Authentication (web portal on the authentication server)

## MAB – MAC Authentication Bypass

+ MAB (MAC Authentication Bypass) is used to…
    + Authenticate non 802.1x capable devices
    + Trigger CWA and BYOD enrollment
    + Technically is NOT an authentication method…just bypasses authentication
+ If MAB is enabled on the switch interface
    + Switch takes each new MAC address and sends it to RADIUS for authentication
        + RADIUS User- Name and RADIUS User-Password equals to the MAC address
        + RADIUS Calling-Station-ID equals to the MAC address
        + RADIUS Service Type is Call-Check (10) for MAB

+ If “Process Host Lookup” is enabled on RADIUS server
    + Authentication is done based on the RADIUS Calling-Station-ID attribute value
+ If “Process Host Lookup” is disabled on RADIUS server
    + Authentication is done based on the RADIUS User-Name and User-Password attributes value

## MAB Configuration Steps on Supplicant

+ None
    + Because MAB is not a authentication protocol
    + It is authentication bypass
    + There is no negotiation between supplicant and NAD

## MAB Configuration Steps on NAD

+ Enable AAA: `aaa new-model`
+ Configure dot1x default authentication list: `aaa authentication dot1x default group`
+ Enable MAB on switch port facing the supplicant: `mab [eap]`
+ Enforce authentication on switch port facing the supplicant: `authentication port-control auto`
+ Define RADIUS server settings: `radius-server host <IP> key <radius key>`
+ Optionally configure other global/interface level settings: `radius-server attribute 31 mac format`

## MAB Configuration Steps on ISE

+ Configure MAB authentication policy
    + Optionally use a default one
+ Configure authorization policy
    + Optionally use a default one
+ Add supplicant’s MAC address into Internal Endpoints Store
    + Authentication performed based on RADIUS Calling Station-ID attribute value

## MAB Verification and Troubleshooting

+ Verification
    + `show mab all`
    + `show authentication session`
    + `show aaa servers`
+ Troubleshooting
    + `show authentication session interface <if>`
    + `debug mab all`
    + `debug radius authentication`

## MAB and 802.1x Common Authorizations

+ VLAN
    + Data VLAN (by name or number)
    + Optional, it overrides the VLAN locally configured on NAD switch port
    + Voice VLAN permission
    + Mandatory for voice domain, allows Phone to join the voice VLAN as configured locally on NAD

## MAB and EAP Common Authorizations

+ Access-Lists
    + dACL (Cisco Proprietary, uses AV pairs)
        + Before 12.2(55)SE code, switch port required a pre-auth ACL to be applied
        + ACL configured on ISE
    + Filter-ID ACL (IETF standard)
        + ACL configured on NAD
    + Per-user ACL (Cisco proprietary, uses AV pairs)
        + ACL configured on ISE and ACE’s pushed through authorization by ISE
        + ACL configured on NAD and ACL name pushed through authorization by ISE
+ ACL Common configuration requirements on NAD
    + `aaa authorization network default group`
    + `dACL also needs radius-server vsa send authentication`
    + `ip device tracking`

## Authorization Verification Troubleshooting

+ Verification
    + `show ip access-list interface <if_number>`
    + `show ip interface <if_number>`
    + `show epm session interface <if_number>`
    + `show authentication interface <if_number>`
    + `show authentication session interface <if_number>`
+ Troubleshooting
    + `show ip device tracking all`
    + `show aaa method-lists authorization`
    + `debug radius authentication`
    + `debug ip device tracking events`





