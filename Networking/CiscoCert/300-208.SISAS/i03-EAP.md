# Authentication & Authorization - EAP

## Extensible Authentication Protocol (EAP)

+ EAP is an authentication framework
    + Mainly used in Wi-Fi and wired
+ 802.1x defines the encapsulation of EAP over IEEE 802, namely EAP over LAN (EAPOL)
+ 802.1x is a flexible layer 2 authentication mechanism
    + Makes use of EAP methods, tunneled inside RADIUS packets
    + Currently there are about 40 different methods defined
+ EAP method types
    + Tunneled (protects the supplicant’s identity and credentials)
    + Non-tunneled (does not protect supplicant’s credentials)

+ 802.1X w/ EAP
    <br/><img src="https://www.cisco.com/c/dam/en/us/td/i/200001-300000/210001-220000/214001-215000/214087.eps/_jcr_content/renditions/214087.jpg" alt="High-Level 802.1X Sequence" href="https://www.cisco.com/c/en/us/td/docs/solutions/Enterprise/Security/TrustSec_1-99/Dot1X_Deployment/Dot1x_Dep_Guide.html" width="450">

+ <a name="EAP-FASTv1">Tunneled EAP</a>
    <br/><img src="https://mrncciew.files.wordpress.com/2013/03/peap-1.png" alt="the PEAP packet flow" href="https://mrncciew.com/2013/03/03/eap-overview/" width="450">

+ 802.1x authentication components
    <br/><img src="https://www.researchgate.net/profile/Choong-Ho_Cho/publication/4374057/figure/fig3/AS:279974889181200@1443762623852/8021x-authentication-components.png" alt="802.1x authentication components " href="urhttps://www.researchgate.net/publication/4374057_Designs_of_a_Secure_Wireless_LAN_Access_Technique_and_an_Intrusion_Detection_System_for_Home_Network/figures?lo=1l" width="300">

## Common EAP Tunneled Methods

+ PEAP - Protected EAP (developed by Microsoft, Cisco, RSA)
    + Two phase method
        + Phase 1, called outer method, used to authenticate server and form the TLS channel
        + Phase 2, called inner method, used to authenticate supplicant and protect its EAP identity
    + Theoretically, inner authentication method can be any EAP type
    + Mutual authentication
        + Server is always authenticated by certificate
        + Supplicant is authenticated by certificate (EAP-TLS), username/password (EAPMSCHAPv2), or OTP (EAP-GTC)
        + Requires server certificates, on client is optional
    + Identity protection available only in PEAPv1 and PEAPv2
    + Data Flow
        <br/><img src="https://sites.google.com/site/amitsciscozone/_/rsrc/1468881647294/home/switching/peap---protected-eap-protocol/PEAP%20message%20exchange.PNG" alt="PEAP" href="https://sites.google.com/site/amitsciscozone/home/switching/peap---protected-eap-protocol" width="450">

+ EAP-FASTv1 (Flexible Authentication via Secure Tunneling)
    + Cisco proprietary, similar with PEAP in scope but very different in functionality
        + Developed to allow faster re-authentication and wireless roaming
    + Based on PAC files (Protected Access Credentials)
        + Can be seen as a cookie locally stored on the supplicant
        + Generated by the RADIUS server from a master key known by itself only
    + Three-phase method
        + Phase 0 is optional and used to provision the supplicant with a PAC file
        + Phase 1 is used to establish the TLS tunnel based on the PAC file
        + Phase 2 is used to authenticate the supplicant within the TLS tunnel
    + [Data Flow - Tunneled EAP](#EAP-FASTv1)

+ EAP-FASTv2 (EAP Chaining)
    + Ties machine authentication to user authentication
        + Relies on machine PAC and user PAC
        + Performs double authentication within single EAP transaction
    + Will become standard, known as EAP-TEAP (RFC draft)
    + Data Flow
        <br/><img src="https://image.slidesharecdn.com/ise2-160329194235/95/ise-20-navy-techday-8-638.jpg?cb=1459281002" alt="Ise 2.0 navy techday" href="https://www.slideshare.net/CiscoPublicSector/ise-20-navy-techday" width="450">

+ EAP-TTLS - Tunneled TLS (RFC 5281)
    + Very similar with PEAP
        + 2-phase method
        + requires server side certificate
    + Major difference as compare to PEAP is that inner method can use any authentication
        + Non-EAP methods such as PAP and CHAP supported
    + Not widely implemented: Two versions
        + EAP-TTLSv0
        + EAP-TTLSv1

+ EAP-TLS (RFC 5216)
    + Single phase protocol
    + Mutual authentication based on certificates
    + Requires client and server certificates
        + TLS tunneled created based on certificates
        + The RFC requires only server side certificates
    + No supplicant identity protection
    + Passed in EAP-Identity and in certificate exchange
    + Message Flow
        <br/><img src="https://mrncciew.files.wordpress.com/2013/03/eap-tls1.png" alt="the EAP-TLS packet flow" href="https://mrncciew.com/2013/03/03/eap-overview/" width="450">

## Common EAP Non-Tunneled Methods

+ EAP-based authentication procedure flow 
    <br/><img src="https://www.researchgate.net/profile/Choong-Ho_Cho/publication/4374057/figure/fig1/AS:279974889181197@1443762623728/EAP-based-authentication-procedure-flow-EAP-MD5-EAP-MD5-is-the-base-security.png" alt="https://www.researchgate.net/publication/4374057_Designs_of_a_Secure_Wireless_LAN_Access_Technique_and_an_Intrusion_Detection_System_for_Home_Network/figures?lo=1" href="EAP-based authentication procedure flow " width="350">

+ EAP-MD5 (RFC2284)
    + The only EAP method defined in original EAP RFC
    + Only supplicant authentication based on username/password
    + Challenge-response through MD5

+ EAP-GTC (RFC3748)
    + Developed by Cisco as alternative to PEAP
    + Supports OTP through challenge-response based authentication of supplicant

+ EAP-LEAP (Light EAP)
    + Cisco proprietary used only for wireless (WEP or TKIP keys)
    + Mutual authentication based on shared secret which is client’s password
    + Uses modified version of MS-CHAP, thus is challenge-response based
    + Supplicant authenticated based on username/password

## 802.1x Configuration Steps

+ 802.1x Configuration Steps on Supplicant
    + Configure the supplicant to use appropriate EAP method
        + It cannot be negotiated
    + Two types of supplicants
        + Built-in operating system supplicant
        + Cisco AnyConnect NAM module
    + Ideally do not let both supplicants configured

+ 802.1x Configuration Steps on NAD
    + Enable AAA: `aaa new-model`
    + Configure dot1x default authentication list: `aaa authentication dot1x default group`
    + Globally enable 802.1x: `dot1x system-auth-control`
    + Enable 802.1x on switch port facing the supplicant: `dot1x pae authenticator`
    + Enforce authentication on switch port facing the supplicant: `authentication port-control auto`
    + Define RADIUS server settings: `radius-server host <IP> key <radius key>`
    + Optionally configure other global/interface level settings

+ 802.1x Configuration Steps on ISE
    + Configure 802.1x authentication policy
        + Optionally use a default one
        + Enable same EAP method as on supplicant
    + Configure authorization policy
        + Optionally use a default one
    + Enroll ISE into PKI infrastructure
        + Only if tunneled EAP methods are used by supplicant
    + Enroll ISE into Active Directory
        + Only if EAP-TLS or EAP-MSCHAPv2 is the authentication method of supplicant

+ 802.1x Verification and Troubleshooting
    + Verification
        + `show dot1x all`
        + `show authentication session`
        + `show authentication interface <if_number>`
        + `show aaa servers`
    + Troubleshooting
        + `show authentication session interface <if_number>`
        + `debug dot1x all` (on the port of Authenticator facing supplicant)
        + `debug radius authentication` (on the port of Authenticator facing Authentication Server)

## Deploying EAP

+ Demo: PEAP (EAP-MSCHAPv2)
    + PC-B Config - Supplicant: Network Adaptor > Properties > Authentication:
        + No Authentication tab: service disabled, to enable by running `services.mcs` > WiredAutoConfig: (stop then) start
        + Enable IEEE 802.1X authentication
        + Enable supplicant
        + Pull down menu: EAP Method
        + Additional settings > Additional EAP Settings > RAP Method=EAP-TLS & PEAP
        + Additional mode: specify authentication mode w/ computer authentication, user authentication, or both
        + Network authentication method settings > validating the certificate: supplicant needs to trust CA that issue the Radius server certificate & Root certificate
        + Select authentication method= inner method
    + SW3 - NAD
        ```cfg
        show dot1x all  ! Sysauthcontrol Disabled
        conf t
        dot1x system-auth-control   ! Enable
        exit
        show run int gi1/0/5        ! mab
        conf t
        int gi1/0/5
          no mab
          dot1x pae authentication
        exit
        show run int gi/10/5
        ! dot1x pae authenticator
        ! authentication port-control auto
    + ISE Settings:
        + Rule: Policy > Authentication: Name=Dot1x; Condition= if wired_802.1x OR wireless_802.1X; Allow Protocols=Default Network Access [PEAP (EAP-MSCHAPv2)] > edit: Use=Internal Users (user/pwd)
        + Conditions: Policy > Policy Elements > Conditions > Authentication > Compound Conditions > Wired_802.1X > Expression=(Radius:service_type=frame), (Radius:NAS-Port-Type=Ethernet)
        + Protocol: Policy > Policy Elements > Results > Authentication > Allow Protocols > Default Network Access: Allow PEAP, Allow PEAP-MSCHAPv2 (inner method)
        + Identity: Administration > Identity Manageemnt > Identity > User > Add: Name=peap-user, pwd=Cisco123! > Submit
        + Rule: Policy > Authorization > First Matched Rule Applied & Default entry: Condition=PermitAccess

+ Demo: EAPOL (PC-B <-- SW3)
    + PC-B: Network Adaptor Settings > Properties > Authentication > Settings:  
        + Additional settings = ...
        + Authentication method=EAP_MSCHAPv2
        + Network adaptor: disable then enable
    + SW3: 
        + msgs for PC-B logon: AUTHMGR-5-SUCCESS: Authorization succeeded for client
        ```cfg
        show authentication sessions    ! Gi1/0/5 Authz Success
        show authentication sessions int gi1/0/5
        ! IP addr=172.16.20.101; User-Name=peap-user, Authorized By=Authentication Server; dot1x=Authz Success
    + PC-B Verification: `ping172.16.2.100` - ok, `telent 172.16.20.1` - ok
    + ISE Verification: <br/> Operations > Authorization Identity=peap-user, Authorization Profiles=PermitAccess > details: Event=5200 Authentication succeeded; Authentication method=dot1X
    + PC-B Validation: Network Adaptor > Properties > Authentication > Settings > Validate server certificate > ok > disable/enable: user=peap-user, pwd=Cisco123! [Could not validate=Supplicant could not trust CA certificate issued] > terminate connection > disable > enable
    + SW3: shutdown port switch
        ```cfg
        conf t
        int gi1/0/5
          shut
          no shut
        exit
        ```
    + PC-B still fail: Network Adaptor > Peroperties > Authentication > disable connect to this server > ok -> user/pwd > Connect
    + SW3 Config: 
        ```cfg
        conf t
        authentication port-control force-authorized
        ```
    + PC-B Verification: 
        + Network Adaptor > disable > enable
        + Browser > http://ISE > login prompt

+ Demo: Export ISE self-signed Certificate & Import to Supplicant
    + ISE generate Certificate: Administration > Certificates > Local Certificate > enable self-signed server certificate > Edit: protocols=EAP + HTTP > Export: Certificate only > Save on Desktop as ISE-selfsigned.pem
    + PC-B: 
        + run `mmc` > file > Add/Remove snap-in > Add Certificates: my user account > Finish > ok > Certificates-Current User > Trusted Root Certification Authorities > Certificates > Al task (right click) > Import > Next > Browse Desktop w/ ISE-selfsigned.pem > ok
        + Validate server certificate -> Trust Root Certification Authorities -> ISE-selfsigned.pem > ok
    + SW3 Config:
        ```cfg
        conf t
        int gi1/0/5
        authentication port-control auto
        ```
    + PC-B: Networ adaptor > disable > enable > user/pwd prompt > ok
    + SW3 Verification" `show authentication sessions` -> Authz Success


## EAP-FASTv1 Implementation

+ Config Procedure:
    1. Supplicant: PC-B
    2. Authenticator: SW3
    3. Authentication Server: ISE

+ Demo: 
    + PC-B: 
        + Network Adaptor > Properties > Authentication > disable IEEE 802.1X Certificate > ok
        + run `services.msc` > Cisco AnyConnect Network Access Manager > properties > Startup Type=Automatic > Apply
    + SW3: `show run int gi1/0/5    ! dot1x pae authenticator`
    + Radius/ISE: 
        + Condition: Policy > Authentication > Dot1X: Allow protocol=EAP-FAST (MSCHAPv2), use=user/pwd
        + Action: Policy > Policy Elements > Results > Authentication > Allow Protocols > Default Network Access: Allow EAP-FAST + MSCHAPv2; Allow EAP-TLS, use PACs -> Anonymous(=unauthenticated) & Authentication
        + Condition: Policy > Authorization > Default: conditions=PermitAccess
    + PC-B: 
        + AnyConnect > user/pwd > Trust
        + `ping 172.163.3.100` - ok; `telnet 172.16.3.100` - ok
    + SW3 Verification
        ```cfg
        show authentication int gi1/0/5     ~ Authz Success
        show authentication sessions int gi1/0/5
        ! Status=Authz Success; Authorized By=Authentication Server;  dot1x=Authc Success; username=pacp-user
    + ISE Verification: Operations > Authentication: Identity=peap-user, Authorization Profiles=PermitAccess > details: Authentication Method=dot1x; Authentication protocol=EAP-FAST (EAP-MSCHAPv2)

## ISE Identity Sources

+ ISE Identity Sources
    + To authenticate and authorize machines/users, ISE can validate their credentials in two ways
        + Internally
        + Externally
    + Internal Store has two types of entries
        + Endpoints (MAC database), organized into groups
            + Blacklist, GuestEndPoints, RegisteredDevices, Profiled
        + Users, organized into groups
        + Guest, ActivatedGuest, Employee, SponsorGroups 
    + Can be used as conditions in Authorization policies
        + Additional groups can be created

+ External Authentication Support
    + ISE can authenticate/proxy against several external sources
        + RADIUS - less likely implemented
        + LDAP
        + Active Directory
        + PKI (ISE CA server support was added in ISE 1.3)
    + Active Directory (AD) integration is the most common one
        + ISE 1.2 supports a single AD integration
            + Multiple AD supports if all within same forest and trust is configured
        + ISE 1.3 supports up to 50 AD domains to be joined
        + Tree structure: Forest (.local) - Domain (x.local, y.local) - Sub-domain (reno.x.local, bushes.x.local)
    + ISE joins AD just like a regular computer
        + Requires administrative rights just for join process
        + Afterwards join, it needs _READ ALL_ rights at the top of the AD/forest schema

+ Active Directory Integration
    + ISE (main controller) and Domain Controller (DC) need to be NTP synchronized
        + Maximum time skew can be _5 minutes_
        + In order to validate supplicant certificates
    + Connectivity requirements between ISE and DC
        + Global Catalog ( TCP 3268/3269)
        + LDAP (UDP/TCP 389)
        + LDAPS (TCP 636)
        + SMB (TCP 445)
        + KDC (TCP 88)
        + KPASS (TCP 466)
    + ASA - stateful FW: config ACL for ISE -> Domain Controller, but not reversed


## Authentication Against AD

+ Authentication against AD
    + Supported authentication options
        + EAP-TLS
        + EAP-MSCHAPv2
    + EAP-TLS
        + Supplicant certificate can be stored in Active Directory schema
        + ISE can be configured to validate supplicant certificate against AD
            + Verify the identity of the machine or user
        + By default in EAP-TLS, ISE just checks if certificate is valid
            + Not expired (certificate validity time compared with ISE clock)
            + Not revoked (uses CRL published by the supplicant’s CA issuer)
    + Example: 
        + CA sever: SRV-B
        + CRL = Certificate Revocation List
        + Msg flow: PC-B -- EAPOL (CERT) --> SW3; SW3 -- RADIUS (CERT) --> ISE1
        + CA server publishes CRL periodically; ISE download CRL list

+ Authorization based on AD
    + Users and computers are objects in the AD schema
        + Identified by their attributes
        + Attributes examples: username, hostname, group membership
    + ISE can use there _attributes_ in authorization policies
        + Allows for authorization policy scalability
        + Example: different authorization can be applied for different groups
    + __Contextual Access__: Authorization done based on multiple inputs/conditions
        + User and computer membership
        + Type of device (identified via profiling)
        + Method and time of network access

+ ISE Configuration for AD Integration
    + Synchronize clock between AD DC and ISE
    + Configure ISE with appropriate DNS server
        + It has to be a Domain Controller
    + Configure ISE with the AD domain name
        + Test connectivity with AD DC
        + Join ISE into AD
    + Define object attributes to be used in authorization policies
        + This step is optional but recommended

## AD Integration

+ Demo Topology
    <br/><img src="diagrams/sisas-net1.png" alt="Demo Topology" width="450">

+ Demo: ISE & PC-B in inelab.local
    + PC-B Config: <br/>
        Computer > Properties > Advanced System Settings > Computer Name > Change: (Retrieved info: DNS server=172.16.20.100) Member of Domain=inelab.local > ok > restart
    + ISE Config
        + Main Functions
            + __Operations__: Monitoring & Troubleshooting
            + __Policy__: Authentication & Authorization settings, including profiling and posture
            + __Administration__: External AD integration
        + Define Store: Admin > Identity Management > External Identity Sources > Active Directory: Domain Name=inelab.local, Identity Store Name=INEAD > Save Configureaiton
        + Connection Functions
            + Test Connection (Basic/Detail): verify connectivity btw ISE and DC
            + Join: join ISE into Domain
            + Leave: remove ISE from Domain
            + Refresh: refresh schema, such as changes on AD
        + : `ISE1-12-inelab.local`: TestConnection > Basic Test: Failed to authenticate use <userName>, Reason: LDAP: "Cannot resolve LDAP Service providers for 'INELAB.LOCAL'" --> check DNS

## ISE Application Server

+ Demo: TRBL
    + Due to privilege issue, using ISE2 istead
    + Logon to ICE2 & with CLI
        ```cfg
        show run 
        ! ip domain-name inelab.loca
        ! ip name-server 172.16.20.100
        conf t
        no ip name-server
        ip name-server 172.16.20.100
        ! restart ISE
        ! ...
        show application status ise
        ```
    + Test Connection > Basic Test > user/pwd -> Success
    + Join: /use/pwd - completed -> close
    + Advanced settings: pwd change, Machine Authentication (using hostname & ticker from DC, diff from User Authentication), Machine Access Restriction (MAR)
    + PC-B <-- SW3: Machine & User Authentication - Machine connected & no user logon -> no network access? background tasks? => Machine mus be authenticated
    + Scenarios
        + Machine Authentication (MA): Authorization Policy A
        + User Authentication (UA): Authorization Policy B
        + MA + UA: Authorization Policy C (MAR), i.e., tie MA to UA for corporate user using corporate device
    + MAR not useful
        + Once machine gets authenticated, ISE will keep the status for 6 hrs (default).
        + The authentication is based on MAC address of the machine - not secure enough
        + e.g., SW3 will keep PC-B's MAC addr for 6 hrs.  Attacker connects to SW3. It can spoof MAC addr of PC-B.


## Identity Prefix & Suffix Strip



## User & Machine Authorization Policies



## Deploying EAP TLS



## Issuing Certificates on ISE



## Enrolling Users on a Certificate



## User Authentication using EAP TLS



## Importing CA Certificates



## EAP-FASTv2 Chaining


